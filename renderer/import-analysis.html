<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.sheetjs.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; img-src * data: blob:;">
    <title>Import Analysis - E-Bike Barn</title>
    <link rel="icon" type="image/png" href="https://store-c8jhcan2jv.mybigcommerce.com/product_images/e-bikebarn-logo-w_1681566343__57813.original.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #e7f1ff;
            border-bottom: 1px solid #dee2e6;
            padding: 15px 20px;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }
        .status-badge {
            font-size: 0.75rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .action-buttons .btn {
            margin-right: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease-in-out;
        }
        .action-buttons .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .action-buttons .btn:last-child {
            margin-right: 0;
        }
        .table td {
            vertical-align: middle;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        
        /* Navbar alignment fixes */
        .navbar-brand {
            display: flex;
            align-items: flex-end;
            padding-bottom: 0;
        }
        
        .navbar-brand img {
            margin-bottom: 0;
        }
        
        .navbar-nav {
            align-items: flex-end;
            padding-bottom: 0.5rem;
        }
        
        .nav-link {
            padding-bottom: 0.5rem;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s ease;
        }
        
        .nav-link:hover {
            border-bottom-color: #fff;
        }
        
        .nav-link.active {
            border-bottom-color: #fff;
        }
        
        /* Ensure navbar has consistent height */
        .navbar {
            min-height: 60px;
            align-items: flex-end;
        }
        
        .navbar .container {
            align-items: flex-end;
        }

        /* Status indicators */
        .status-config { background-color: #e3f2fd; }
        .status-cards { background-color: #fff3e0; }
        .status-images { background-color: #f3e5f5; }
        .status-hypa { background-color: #e8f5e8; }
        .status-complete { background-color: #e8f5e8; }

        .progress-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-card {
            transition: all 0.3s ease;
        }

        .analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* Improved status badge and row colors for readability */
        .table-secondary { background-color: #f8f9fa !important; color: #212529 !important; }
        .table-warning { background-color: #fff3cd !important; color: #212529 !important; }
        .table-info { background-color: #d1ecf1 !important; color: #212529 !important; }
        .table-success { background-color: #d4edda !important; color: #212529 !important; }
        .status-badge.bg-secondary { background-color: #6c757d !important; color: #fff !important; }
        .status-badge.bg-warning { background-color: #ffc107 !important; color: #212529 !important; }
        .status-badge.bg-info { background-color: #17a2b8 !important; color: #fff !important; }
        .status-badge.bg-success { background-color: #28a745 !important; color: #fff !important; }

        /* Improve table heading contrast for export selection table */
        #exportSelectionTable thead th {
            background-color: #212529 !important;
            color: #fff !important;
            font-weight: bold;
            border-bottom: 2px solid #444 !important;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <img src="https://store-c8jhcan2jv.mybigcommerce.com/product_images/e-bikebarn-logo-w_1681566343__57813.original.png" alt="E-Bike Barn" height="40" class="me-2">
                <span>E-Bike Barn Configuration Manager</span>
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">Home</a>
                <a class="nav-link" href="card-creator.html">Card Creator</a>
                <a class="nav-link" href="card-manager.html">Card Manager</a>
                
                <a class="nav-link" href="webdav-explorer.html">File Explorer</a>
                <a class="nav-link active" href="import-analysis.html">Import Analysis</a>
                <a class="nav-link" href="settings.html">Settings</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h2><i class="fas fa-chart-line me-2"></i>Import Analysis Dashboard</h2>
                    <div>
                        <button class="btn btn-primary me-2" id="refreshAnalysisBtn">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Analysis
                        </button>
                        <button class="btn btn-success me-2" id="importBigCommerceBtn" data-bs-toggle="modal" data-bs-target="#importBigCommerceModal">
                            <i class="fas fa-shopping-cart me-2"></i>Import BigCommerce Products
                        </button>
                        <button class="btn btn-info me-2" id="importHypaBtn" data-bs-toggle="modal" data-bs-target="#importHypaModal">
                            <i class="fas fa-download me-2"></i>Import Hypa Metafields
                        </button>
                        <button class="btn btn-warning me-2" id="exportHypaBtn" data-bs-toggle="modal" data-bs-target="#exportHypaModal">
                            <i class="fas fa-upload me-2"></i>Export to Hypa Metafields
                        </button>
                        <button class="btn btn-outline-warning" id="placeholderSummaryBtn" onclick="showPlaceholderCardSummary()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Placeholder Cards
                        </button>
                    </div>
                </div>
                <p class="text-muted">Import bike configurations from BigCommerce Products or existing cards from Hypa Metafields, then export them back to Hypa.</p>
            </div>
        </div>

        <!-- Import/Export Workflow Info -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-download me-2"></i>Import FROM BigCommerce Products</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Source:</strong> <a href="https://store-c8jhcan2jv.mybigcommerce.com/manage/products" target="_blank">BigCommerce Products Section</a></p>
                        <p class="mb-2"><strong>Data:</strong> Product information, variants, SKUs, descriptions</p>
                        <p class="mb-0"><strong>Result:</strong> Creates new bike configuration cards</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-download me-2"></i>Import FROM Hypa Metafields</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Source:</strong> Hypa MetaFields App CSV Export</p>
                        <p class="mb-2"><strong>Data:</strong> Existing card data that's already been created</p>
                        <p class="mb-0"><strong>Purpose:</strong> Import existing cards to avoid recreating them</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Export TO Hypa Metafields</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Destination:</strong> Hypa MetaFields App within BigCommerce</p>
                        <p class="mb-2"><strong>Data:</strong> Created cards with images and metadata</p>
                        <p class="mb-0"><strong>Purpose:</strong> Send completed cards back to BigCommerce for display</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card analysis-card">
                    <div class="card-body text-center">
                        <h3 id="totalConfigs" class="text-primary">0</h3>
                        <p class="mb-0">BigCommerce Variants (SKUs)</p>
                        <small class="text-muted">Total Variants</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analysis-card">
                    <div class="card-body text-center">
                        <h3 id="totalCards" class="text-warning">0</h3>
                        <p class="mb-0">Cards Created</p>
                        <small class="text-muted">Total Cards</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analysis-card">
                    <div class="card-body text-center">
                        <h3 id="totalImages" class="text-info">0</h3>
                        <p class="mb-0">Images Uploaded</p>
                        <small class="text-muted">Unique Images</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card analysis-card">
                    <div class="card-body text-center">
                        <h3 class="text-success mb-1">
                            <span id="totalHypaImported">0</span> <small class="text-muted" style="font-size:1rem;">Imported</small><br>
                            <span id="totalHypaExported">0</span> <small class="text-muted" style="font-size:1rem;">Exported</small>
                        </h3>
                        <p class="mb-0">Hypa Metafields</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="progress-section">
            <h4><i class="fas fa-tasks me-2"></i>Workflow Progress</h4>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Products with Cards Created</label>
                        <div class="progress">
                            <div class="progress-bar bg-warning" id="cardsProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="cardsProgressText">0 of 0 products have cards created</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Cards with Images Uploaded</label>
                        <div class="progress">
                            <div class="progress-bar bg-info" id="imagesProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="imagesProgressText">0 of 0 cards have images uploaded</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Cards Exported to Hypa Metafields</label>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="hypaProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="hypaProgressText">0 of 0 cards exported to Hypa</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Complete Workflow<br>Import From BigCommerce → Create Cards → Import from Hypa Metafields → Upload Images to WebDAV → Export to Hypa Metafields)</label>
                        <div class="progress">
                            <div class="progress-bar bg-success" id="completeProgress" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="completeProgressText">0 of 0 products fully processed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Analytics Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="progress-section">
                    <h4><i class="fas fa-chart-bar me-2"></i>Import Success Metrics</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Success Rate (Last 30 days)</label>
                                <div class="progress">
                                    <div class="progress-bar bg-success" id="successRateProgress" role="progressbar" style="width: 85%"></div>
                                </div>
                                <small class="text-muted" id="successRateText">85% successful imports</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Average Import Time</label>
                                <div class="d-flex align-items-center">
                                    <h5 class="mb-0 me-2" id="avgImportTime">2.3s</h5>
                                    <small class="text-muted">per configuration</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="progress-section">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>Common Issues</h4>
                    <div id="commonIssuesList">
                        <div class="alert alert-warning py-2 mb-2">
                            <small><i class="fas fa-info-circle me-1"></i>Missing SKU codes (12 items)</small>
                        </div>
                        <div class="alert alert-info py-2 mb-2">
                            <small><i class="fas fa-image me-1"></i>Images not uploaded (8 items)</small>
                        </div>
                        <div class="alert alert-danger py-2 mb-2">
                            <small><i class="fas fa-sync me-1"></i>Hypa metafields not updated (15 items)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import History Section -->
        <div class="form-section mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-history me-2"></i>Recent Import History</h4>
                <button class="btn btn-outline-primary btn-sm" id="viewAllHistoryBtn">
                    <i class="fas fa-list me-1"></i>View All History
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>File</th>
                            <th>Items</th>
                            <th>Success</th>
                            <th>Errors</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="importHistoryTable">
                        <!-- Import history will be populated here by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobile Backup Section -->
        <div class="form-section mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-mobile-alt me-2"></i>Mobile Backup & Sync</h4>
                <small class="text-muted">Export/Import cards for mobile use</small>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-download me-2"></i>Export Cards</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Download all your cards as a JSON file for backup or transfer to another device.</p>
                            <button class="btn btn-success" onclick="exportCardsToFile()">
                                <i class="fas fa-download me-2"></i>Export Cards Backup
                            </button>
                            <button class="btn btn-danger ms-2" id="resetCardsBtn" data-bs-toggle="modal" data-bs-target="#resetCardsModal">
                                <i class="fas fa-trash-alt me-2"></i>Reset Cards
                            </button>
                            <small class="text-muted d-block mt-2">File will be saved as: cards-backup-YYYY-MM-DD.json</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-upload me-2"></i>Import Cards</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Import cards from a backup file to restore or sync data.</p>
                            <input type="file" class="form-control mb-2" id="importCardsFile" accept=".json" style="display: none;">
                            <button class="btn btn-info" onclick="document.getElementById('importCardsFile').click()">
                                <i class="fas fa-upload me-2"></i>Select Backup File
                            </button>
                            <small class="text-muted d-block mt-2">Select a previously exported cards backup file</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-sync me-2"></i>Card Migration & Renewal</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-3">Update old card formats to the current schema. View old card content and easily renew them.</p>
                            <button class="btn btn-warning me-2" onclick="migrateAndUpdateCards()" data-bs-toggle="modal" data-bs-target="#importHypaModal">
                                <i class="fas fa-sync me-2"></i>Check & Migrate Cards
                            </button>
                            <button class="btn btn-danger" onclick="cleanupBadCards()">
                                <i class="fas fa-trash me-2"></i>Clean Up Bad Cards
                            </button>
                            <small class="text-muted d-block mt-2">Automatically detects old format cards and lets you view/renew them. Clean up removes cards with generic titles and no content.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Mobile Compatibility:</strong> Cards are automatically saved to your browser's localStorage for offline access. 
                Use the export/import functions to transfer data between devices or create backups.
            </div>
        </div>

        <!-- Detailed Analysis Table -->
        <div class="form-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-table me-2"></i>Detailed Status Analysis</h4>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" id="exportAnalysisBtn">
                        <i class="fas fa-download me-1"></i>Export Analysis
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="filterStatusBtn">
                        <i class="fas fa-filter me-1"></i>Filter by Status
                    </button>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>SKU</th>
                            <th>Brand</th>
                            <th>Model</th>
                            <th>Generation</th>
                            <th>Configuration</th>
                            <th>Cards</th>
                            <th>Images</th>
                            <th>Hypa Metafields</th>
                            <th>Overall Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- BigCommerce Import Modal -->
    <div class="modal fade" id="importBigCommerceModal" tabindex="-1" aria-labelledby="importBigCommerceModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importBigCommerceModalLabel">
                        <i class="fas fa-shopping-cart me-2"></i>Import from BigCommerce Products
                    </h5>
                    <div class="ms-auto me-3">
                        <button type="button" class="btn btn-outline-info btn-sm" id="restoreImportStateBtn" onclick="restoreImportState()" style="display: none;">
                            <i class="fas fa-undo me-1"></i>Restore Previous Import
                        </button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Upload -->
                    <div id="importStep1">
                        <h6><i class="fas fa-upload me-2"></i>Step 1: Upload CSV File</h6>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Export your products from BigCommerce Admin → Products → Export, then upload the CSV file here.
                        </div>
                        
                        <div class="mb-3">
                            <label for="bigcommerceCsvFile" class="form-label">Select BigCommerce Products CSV:</label>
                            <input type="file" class="form-control" id="bigcommerceCsvFile" accept=".csv" />
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> This will import product configurations. You can choose whether to create new configurations or add to existing ones.
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary" id="uploadAndValidateBigCommerceBtn">
                                <i class="fas fa-upload me-2"></i>Upload and Validate
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Validation -->
                    <div id="importStep2" style="display: none;">
                        <h6><i class="fas fa-check-circle me-2"></i>Step 2: Validation Results</h6>
                        
                        <div id="validationResultsBigCommerce">
                            <!-- Validation results will be populated here -->
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToUploadBigCommerceBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Upload
                            </button>
                            <button type="button" class="btn btn-primary" id="continueToMappingBigCommerceBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Field Mapping
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Field Mapping -->
                    <div id="importStep3" style="display: none;">
                        <h6><i class="fas fa-map me-2"></i>Step 3: Field Mapping</h6>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Field Mapping:</strong> Map CSV columns to bike configuration fields. The system will try to auto-detect mappings.
                        </div>
                        
                        <div id="fieldMappingBigCommerce">
                            <!-- Field mapping will be populated here -->
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToValidationBigCommerceBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Validation
                            </button>
                            <button type="button" class="btn btn-primary" id="continueToConfigMatchBigCommerceBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Configuration Matching
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Configuration Matching -->
                    <div id="importStep4" style="display: none;">
                        <h6><i class="fas fa-link me-2"></i>Step 4: Configuration Matching</h6>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Configuration Matching:</strong> Choose whether to create new configurations or add variants to existing ones.
                        </div>
                        
                        <div id="configMatchingBigCommerce">
                            <!-- Configuration matching will be populated here -->
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToMappingBigCommerceBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Field Mapping
                            </button>
                            <button type="button" class="btn btn-primary" id="continueToReviewBigCommerceBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Review
                            </button>
                        </div>
                    </div>

                    <!-- Step 5: Final Review -->
                    <div id="importStep5" style="display: none;">
                        <h6><i class="fas fa-eye me-2"></i>Step 5: Final Review</h6>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Review Import:</strong> Review the final import summary before confirming.
                        </div>
                        
                        <div id="finalReviewBigCommerce">
                            <!-- Final review will be populated here -->
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToConfigMatchBigCommerceBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Configuration Matching
                            </button>
                            <button type="button" class="btn btn-success" id="confirmImportBigCommerceBtn">
                                <i class="fas fa-check me-2"></i>Confirm Import
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hypa Import Modal -->
    <div class="modal fade" id="importHypaModal" tabindex="-1" aria-labelledby="importHypaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="importHypaModalLabel">
                        <i class="fas fa-download me-2"></i>Import from Hypa Metafields
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Import from Hypa:</strong> Upload a CSV file exported from the Hypa MetaFields App to import existing card data and avoid recreating cards.
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>How to Export from Hypa</h6>
                                </div>
                                <div class="card-body">
                                    <ol class="mb-0">
                                        <li>Go to your BigCommerce store admin</li>
                                        <li>Navigate to <strong>Apps > Hypa MetaFields</strong></li>
                                        <li>Click <strong>Export</strong> or <strong>Download CSV</strong></li>
                                        <li>Save the file to your computer</li>
                                        <li>Upload it here to import existing cards</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>What Gets Imported</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li><strong>Card titles</strong> and content</li>
                                        <li><strong>Product SKUs</strong> for matching</li>
                                        <li><strong>Card types</strong> (feature, options, etc.)</li>
                                        <li><strong>Image URLs</strong> if available</li>
                                        <li><strong>Metafield IDs</strong> for reference</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="hypaCsvFile" class="form-label">
                            <i class="fas fa-file-csv me-2"></i>Select Hypa Metafields CSV Export:
                        </label>
                        <input type="file" class="form-control" id="hypaCsvFile" accept=".csv" />
                        <div class="form-text">
                            <i class="fas fa-lightbulb me-1"></i>
                            The file should contain columns like SKU, Title, Content, Card Type, etc.
                        </div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Note:</strong> This will import existing cards from Hypa. Cards with the same SKU will be skipped to avoid duplicates.
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Important:</strong> Only cards for products that have been imported from BigCommerce will be created. 
                        If you haven't imported a product from BigCommerce yet, its Hypa cards will be skipped.
                    </div>
                    
                    <!-- Debug test button -->
                    <div class="alert alert-info">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="testHypaFlow()">
                            <i class="fas fa-bug me-1"></i>Test Flow (Debug)
                        </button>
                        <small class="text-muted ms-2">Click this to test the import flow without a file</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmHypaImportBtn" disabled>
                        <i class="fas fa-upload me-2"></i>Select File First
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export to Hypa Modal -->
    <div class="modal fade" id="exportHypaModal" tabindex="-1" aria-labelledby="exportHypaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="exportHypaModalLabel">
                        <i class="fas fa-upload me-2"></i>Export to Hypa Metafields
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Progress Steps -->
                    <div class="mb-4">
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-warning" id="exportProgress" role="progressbar" style="width: 25%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span class="badge bg-warning" id="exportStep1Badge">Step 1: Analyze</span>
                            <span class="badge bg-secondary" id="exportStep2Badge">Step 2: Compare</span>
                            <span class="badge bg-secondary" id="exportStep3Badge">Step 3: Select</span>
                            <span class="badge bg-secondary" id="exportStep4Badge">Step 4: Export</span>
                        </div>
                    </div>

                    <!-- Step 1: Analysis -->
                    <div id="exportAnalysisStep">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Local Cards and Hypa Metafields Analysis</h6>
                            <p class="mb-0">
                                Your data has been loaded and analyzed. Click "Continue to Comparison" to see what will be <strong>added</strong>, <strong>updated</strong>, <strong>kept</strong>, or <strong>removed</strong>.<br>
                                <strong>Label criteria:</strong><br>
                                <ul style="margin-bottom:0;">
                                    <li><strong>Add</strong>: This card does not exist in Hypa and will be added to an existing row.</li>
                                    <li><strong>Update</strong>: This card exists in Hypa, but your local version is different and will overwrite the Hypa version.</li>
                                    <li><strong>Keep</strong>: This card is identical to what's already in Hypa (no changes detected), so it will be preserved.</li>
                                    <li><strong>Remove</strong>: This card exists in Hypa but you want to clear/remove it from the website.</li>
                                </ul>
                            </p>
                        </div>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Tip:</strong> You <b>do not need</b> to import a Hypa Metafields CSV to export your cards. However, <b>importing an up-to-date Hypa Metafields CSV</b> lets you see which cards are new, which will update, and which will be skipped—helping you avoid accidental overwrites or duplicates. For best results, always export the latest data from Hypa and import it here before exporting new cards.
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-desktop me-2"></i>Local Cards</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Total Cards:</span>
                                            <span id="localTotalCards">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>With Images:</span>
                                            <span id="localWithImages">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Ready to Export:</span>
                                            <span id="localReadyToExport">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-cloud me-2"></i>Hypa Metafields</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Existing Metafields:</span>
                                            <span id="hypaExistingCount">0</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Last Updated:</span>
                                            <span id="hypaLastUpdated">Unknown</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Status:</span>
                                            <span id="hypaConnectionStatus">Checking...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="startAnalysisBtn">
                            <i class="fas fa-arrow-right me-2"></i>Continue to Comparison
                        </button>
                    </div>

                    <!-- Step 2: Comparison Results -->
                    <div id="exportComparisonStep" style="display: none;">
                        <h6><i class="fas fa-exchange-alt me-2"></i>Comparison Results</h6>
                        
                        <div class="row mb-4">
                            <div class="col-md-2">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 id="exportNewCount">0</h4>
                                        <small>Add</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h4 id="exportUpdateCount">0</h4>
                                        <small>Update</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h4 id="exportSkipCount">0</h4>
                                        <small>Keep</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h4 id="exportConflictCount">0</h4>
                                        <small>Remove</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body text-center">
                                        <h4 id="exportExcludedCount">0</h4>
                                        <small>Excluded</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Excluded SKUs Summary -->
                        <div id="excludedSkusSummary"></div>

                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-sm table-striped" id="exportComparisonTable">
                                <thead class="table-secondary">
                                    <tr>
                                        <th>Product</th>
                                        <th>Card Type</th>
                                        <th>Local Status</th>
                                        <th>Hypa Status</th>
                                        <th>Action</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="exportComparisonTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToAnalysisBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                            </button>
                            <button type="button" class="btn btn-primary" id="continueToSelectionBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Selection
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Selection -->
                    <div id="exportSelectionStep" style="display: none;">
                        <h6><i class="fas fa-check-square me-2"></i>Select What to Export</h6>
                        
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Review Carefully:</strong> Select which cards you want to keep in the final CSV. Unselected cards will be removed/cleared from the website.
                        </div>

                        <!-- Override Options -->
                        <div class="mb-3" id="overrideOptions" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Override Options:</strong> You can choose to include incomplete cards, but this may cause data loss.
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeExcludedCards">
                                <label class="form-check-label" for="includeExcludedCards">
                                    <span class="badge bg-secondary">Include Excluded Cards</span> Include cards with missing data (not recommended)
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllAdd" checked>
                                <label class="form-check-label" for="selectAllAdd">
                                    <span class="badge bg-success">Add</span> Keep all new cards (safe)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllUpdates" checked>
                                <label class="form-check-label" for="selectAllUpdates">
                                    <span class="badge bg-warning">Updates</span> Keep all updated cards (will overwrite)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllKeep" checked>
                                <label class="form-check-label" for="selectAllKeep">
                                    <span class="badge bg-info">Keep</span> Keep all unchanged cards (preserve)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAllRemove" checked>
                                <label class="form-check-label" for="selectAllRemove">
                                    <span class="badge bg-danger">Remove</span> Remove cards from website (clear)
                                </label>
                            </div>
                        </div>

                        <!-- Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-2">
                                <label class="form-label">Search SKU:</label>
                                <input type="text" class="form-control form-control-sm" id="skuSearchFilter" placeholder="Enter SKU...">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Model:</label>
                                <select class="form-select form-select-sm" id="modelFilter">
                                    <option value="">All Models</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Generation:</label>
                                <select class="form-select form-select-sm" id="generationFilter">
                                    <option value="">All Generations</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Card Type:</label>
                                <select class="form-select form-select-sm" id="cardTypeFilter">
                                    <option value="">All Types</option>
                                    <option value="feature">Feature</option>
                                    <option value="product-options">Product Options</option>
                                    <option value="cargo-options">Cargo Options</option>
                                    <option value="weather-protection">Weather Protection</option>
                                    <option value="specification-table">Specification Table</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Action:</label>
                                <select class="form-select form-select-sm" id="actionFilter">
                                    <option value="">All Actions</option>
                                    <option value="new">Add (New)</option>
                                    <option value="update">Update</option>
                                    <option value="keep">Keep</option>
                                    <option value="remove">Remove</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Sort By:</label>
                                <select class="form-select form-select-sm" id="sortFilter">
                                    <option value="sku">SKU (A-Z)</option>
                                    <option value="sku-desc">SKU (Z-A)</option>
                                    <option value="model">Model</option>
                                    <option value="generation">Generation</option>
                                    <option value="cardType">Card Type</option>
                                    <option value="action">Action</option>
                                    <option value="lastModified">Last Modified</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive" style="max-height: 400px;">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-muted" id="exportSelectionCount">Loading...</small>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearExportFilters()">
                                    <i class="fas fa-times me-1"></i>Clear Filters
                                </button>
                            </div>
                            <table class="table table-sm table-striped" id="exportSelectionTable">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th class="text-white fw-bold"><input type="checkbox" id="selectAllCheckbox"></th>
                                        <th class="text-white fw-bold">Position</th>
                                        <th class="text-white fw-bold">SKU</th>
                                        <th class="text-white fw-bold">Card Type</th>
                                        <th class="text-white fw-bold">Title</th>
                                        <th class="text-white fw-bold">Action</th>
                                        <th class="text-white fw-bold">Last Modified</th>
                                        <th class="text-white fw-bold">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="exportSelectionTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div id="exportSelectionSummaryPanel" class="mb-3"></div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToComparisonBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Comparison
                            </button>
                            <button type="button" class="btn btn-primary" id="continueToExportBtn">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Export
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Final Export -->
                    <div id="exportFinalStep" style="display: none;">
                        <h6><i class="fas fa-download me-2"></i>Final Export</h6>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Export Summary</h6>
                            <p class="mb-0">Review the final summary below. This will create a file that you can import into the Hypa MetaFields App in BigCommerce.</p>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h4 id="finalExportNewCount">0</h4>
                                        <small>New Cards</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h4 id="finalExportUpdateCount">0</h4>
                                        <small>Updates</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-danger text-white">
                                    <div class="card-body text-center">
                                        <h4 id="finalExportConflictCount">0</h4>
                                        <small>Conflicts</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <h4 id="finalExportTotalCount">0</h4>
                                        <small>Total</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Export Format:</label>
                            <select class="form-select" id="exportFormat">
                                <option value="csv">CSV File (Recommended for Hypa)</option>
                                <option value="json">JSON File</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Card Numbering System:</label>
                            <select class="form-select" id="cardNumberingSystem">
                                <option value="sequential">Simple Sequential (1, 2, 3, 4, 5...)</option>
                                <option value="grouped">Grouped by SKU & Type (1,2,3 per group)</option>
                                <option value="alphabetical">Alphabetical by Title</option>
                                <option value="creation-date">By Creation Date</option>
                                <option value="last-modified">By Last Modified</option>
                                <option value="price">By Price (for product options)</option>
                            </select>
                            <small class="form-text text-muted">Choose how card positions are numbered in the export</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Export Options:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeMetadata" checked>
                                <label class="form-check-label" for="includeMetadata">
                                    Include image metadata (recommended)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="includeBackup" checked>
                                <label class="form-check-label" for="includeBackup">
                                    Create backup of existing data
                                </label>
                            </div>
                        </div>

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Important:</strong> After downloading, you'll need to manually import this file into the Hypa MetaFields App in BigCommerce.
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Export Options:</h6>
                            <ul class="mb-0">
                                <li><strong>Export with Original Structure:</strong> Requires Hypa CSV import first. Preserves the exact Hypa format for perfect round-trip compatibility.</li>
                                <li><strong>Export Simple CSV:</strong> Works without Hypa data. Creates a simple CSV with all your cards that you can manually process.</li>
                            </ul>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-secondary" id="backToSelectionBtn">
                                <i class="fas fa-arrow-left me-2"></i>Back to Selection
                            </button>
                            <button type="button" class="btn btn-warning" id="confirmExportBtn">
                                <i class="fas fa-download me-2"></i>Download Export File
                            </button>
                            <button type="button" class="btn btn-success" onclick="exportToHypaFormat()">
                                <i class="fas fa-sync me-2"></i>Export with Original Structure
                            </button>
                            <button type="button" class="btn btn-info" onclick="exportCardsToSimpleCsv()">
                                <i class="fas fa-file-csv me-2"></i>Export Simple CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div class="toast" id="analysisToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="fas fa-info-circle text-info me-2"></i>
                <strong class="me-auto">Analysis Status</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="analysisToastBody">
                Analysis completed successfully!
            </div>
        </div>
    </div>

    <!-- Reset Cards Modal -->
    <div class="modal fade" id="resetCardsModal" tabindex="-1" aria-labelledby="resetCardsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetCardsModalLabel"><i class="fas fa-trash-alt me-2"></i>Reset Cards</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">This will permanently delete <strong>all</strong> card JSON files and related cache on this computer.</p>
                    <p class="fw-bold">Choose an option:</p>
                    <ul>
                        <li><strong>Backup &amp; Delete</strong> &ndash; Downloads a backup of all cards <em>before</em> deletion.</li>
                        <li><strong>Delete Only</strong> &ndash; Deletes without creating a backup.</li>
                    </ul>
                    <div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>This action cannot be undone.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteOnlyBtn">Delete Only</button>
                    <button type="button" class="btn btn-warning" id="backupDeleteBtn">Backup &amp; Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="card-manager.js"></script>
    <script src="import-analysis.js"></script>
</body>
</html> 